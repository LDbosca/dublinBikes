<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<!-- <script src="{{ url_for('static',filename='jquery-3.3.1.js') }}"></script> -->
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/momentjs/2.14.1/moment.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">
<link href="https://fonts.googleapis.com/css?family=Roboto|Poppins|Roboto+Slab|Patua+One" rel="stylesheet">
    
<title>Dublin Bikes</title>
{{ charts_init }}
</head>

<body>
<!--HTML element to hold the map:!-->
<div id="googleMap" style="width:100%;height:500px;"></div>
{{ charts.AvailabilityChart }}
<div id="weather">
    <h2>Current Weather Conditions</h2>

    <p> The current weather is {{ wds[0]['weatherDescr'] }} </p>
    <p> The current temperature is {{ wds[0]['temperature'] }} degrees centigrade</p>
    <img src="http://openweathermap.org/img/w/{{wds[0]['weatherIcon']}}.png">
    
    <br>
    {% if forecast %}
    <p>The forecasted weather is {{ futureWeatherJson['weather'][0]['description']}}<br>
        The forecasted temperature is {{ futureWeatherJson['main']['temp']}}<br>
    </p>
    <img src="http://openweathermap.org/img/w/{{futureWeatherJson['weather'][0]['icon']}}.png">
    {% endif %}
    {% if bikeStation %}
    <p>You have selected the <b>{{ bikeStation }}</b> bike station</p>
    {% endif %}
    {% if stringTime %}
    <p>You have selected <b>{{ stringTime }}</b> for your journey</p>
    {% endif %}
</div>

    <div class="container">
    <div class='col-md-5'>
        <div class="form-group">
            <p> Pick-up date </p>
            <div class='input-group date' id='datetimepicker1'>
                <input type='text' class="form-control" />
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
            <p> Pick-up location </p>
            <div id="stationsPickUp" ></div>
        </div>
    </div>
    <div class='col-md-5'>
        <div class="form-group">
            <p> Drop-off date </p>
            <div class='input-group date' id='datetimepicker2'>
                <input type='text' class="form-control" />
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
        </div>
        <p> Drop-off station </p>
        <div id="stationsDropOff" ></div>
        <br>
        <input type="submit" class="btn btn-primary" value="Submit" onclick="displayselection()">
    </div>
</div>


    
<script>
// date and time picker limited to the next 5 days to match weather forecast
var todayDate = new Date().getDate();

$(function () {
    $('#datetimepicker1').datetimepicker({
        minDate: new Date(),
        maxDate: new Date(new Date().setDate(todayDate + 5)),
        disabledHours: [1, 2, 3, 4],
        disabledTimeIntervals: [moment({ h: 0, m: 30 }), moment({ h: 5 })],
        stepping: 15
});
    $('#datetimepicker2').datetimepicker({
        useCurrent: false, 
        maxDate: new Date(new Date().setDate(todayDate + 5)),
        disabledHours: [1, 2, 3, 4],
        disabledTimeIntervals: [moment({ h: 0, m: 30 }), moment({ h: 5 })],
        stepping: 15
    });
    $("#datetimepicker1").on("dp.change", function (e) {
        $('#datetimepicker2').data("DateTimePicker").minDate(e.date);
    });
    $("#datetimepicker2").on("dp.change", function (e) {
        $('#datetimepicker1').data("DateTimePicker").maxDate(e.date);
    });
});
    
  
// function that displays user's selection after submitting request
function displayselection() {
    // pass date time value to a variable
    var selectedPickUpTime = $('#datetimepicker1').data("DateTimePicker").date();
    var selectedDropOffTime = $('#datetimepicker2').data("DateTimePicker").date(); 
    
    if (selectedPickUpTime) {
    //convert time in unix format
    var selectedPickUpTimeUNIX = selectedPickUpTime.unix();
    var selectedDropOffTimeUNIX = selectedDropOffTime.unix();
    }

    // pass selected station
    var selPickUpStation = $('#pickupstation').val();
    var selDropOffStation = $('#dropoffstation').val();
    
    // get address of main page
    var host = window.location.href;
    // add station
    host += selPickUpStation
    host += "/"
    // append appropriate timestamp
    host += selectedPickUpTimeUNIX;
    // append drop off station
    host += "/"
    host += selDropOffStation
    // append appropriate drop off timestamp
    host += "/"
    host += selectedDropOffTimeUNIX
    
    //navigate to app route for station/time
    window.location.replace(host)

}
    
function myMap() {
//The mapProp variable defines the properties for the map.
var mapProp= {
  center:new google.maps.LatLng(53.350140, -6.266155), //center in Dublin
  zoom:13,
};
//creates a new map inside the <div> element using the parameters that are passed (mapProp).
var map = new google.maps.Map(document.getElementById("googleMap"),mapProp);

// ROOT is the location of our flask app
ROOT = window.location.origin; 
    
//using jQuery to import JSON file from flask and pass it to the function 
$.getJSON(ROOT + '/stations', function (data) {
    displayStation(data);
    dropDown(data);
});

// function that populates dropdown menu with stations
function dropDown(obj){

    var stations = obj;
    // creating an array that will contain all Countries
    var stationList = [];
    // loop that iterates thtough the object
    // pushing Countries into array after checking if they have been already added
    for (var i=0; i <stations.length; i++) {  
        if (stationList.indexOf(stations[i].stationName) == -1){
            stationList.push(stations[i].stationName)
        }}
        // this will sort the array in alphabetical order
        stationList.sort();
    
    //creating the selection drop down menu with a loop that iterates thourgh the array
    var selPickUpStation = "<select id=pickupstation>"
    selPickUpStation += "<option value=" + 'selStation' + ">"+ 'Select Station:' +"</option>"
    for (i=0; i <stationList.length; i++){
        selPickUpStation += "<option value=\""+stationList[i]+"\">"+ stationList[i] + "</option>"
        }
    selPickUpStation += "</select>"
    
    document.getElementById("stationsPickUp").innerHTML = selPickUpStation;
   
    var selDropOffStation = "<select id=dropoffstation>"
    selDropOffStation += "<option value=" + 'selStation' + ">"+ 'Select Station:' +"</option>"
    for (i=0; i <stationList.length; i++){
        selDropOffStation += "<option value=\""+stationList[i]+"\">"+ stationList[i] + "</option>"
        }
    selDropOffStation += "</select>"    
    
    document.getElementById("stationsDropOff").innerHTML = selDropOffStation;
    
}    


//function that displays stations and info on map
function displayStation(obj) {
    // variable that contains station information
    var stations = obj;
    // variable that contains circle color 
    var circleColor;
    //static infoWindow for all your markers
    var infowindow = new google.maps.InfoWindow(); 
    // loop that iterates through the object and extract information
    for(var i = 0; i < stations.length; i++){
        var loc = new google.maps.LatLng(stations[i].stationLat, stations[i].stationLong);
        var content = '<div><p> Station Name:  ' + stations[i].stationName + '</p><p> Total bike stands:  ' + stations[i].stationStands + '</p><p> Credit Card accepted:  ' + stations[i].stationBanking + '</p><p> Available bike stands:  ' + stations[i].stationStdsAvailable + '</p><p> Available bikes: ' + stations[i].stationBikesAvailable + '</p></div>';
        var marker = new google.maps.Marker({
             position: loc,
             map: map,
             title: stations[i].name});
        
        //base color of the circle on the marker on bike availability
        if (stations[i].stationBikesAvailable == 0) { 
               circleColor = '#ff0000'}
        else if (stations[i].stationBikesAvailable <=3 ) { 
               circleColor = '#fff010'}
        else {
            circleColor = '#13f72a'};
        
        //plot a circle on each bike location
        var bikeCircle = new google.maps.Circle({
            strokeWeight: 0,
            fillColor: circleColor,
            fillOpacity: 0.7,
            map: map,
            center: loc,
            radius: 50 + stations[i].stationBikesAvailable
        });
        
    google.maps.event.addListener(marker,'click', (function(marker,content,infowindow){ 
        return function() {
           infowindow.setContent(content);
           infowindow.open(map,marker);
        };
    })(marker,content,infowindow)); 
        
    }    
    
    
}
}

</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMsv7Vw1OJPpTQ2rb6NtrjYykltKPbti4&callback=myMap">
</script>

</body>
</html>